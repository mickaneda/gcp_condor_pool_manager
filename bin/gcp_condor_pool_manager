#!/usr/bin/env bash

if ! type gcloud >& /dev/null;then
  echo "Intall gcloud: https://cloud.google.com/sdk/install"
  exit 1
fi

# Config file
CONFIG_FILE=~/.config/gcp_condor_pool_manager/config

# Default parameters
max=0
prefix_1core=""
image=""
preemptible=0
zones=""
reuse=0
params=(max prefix_1core image preemptible zones reuse)

# Show setup
show_setup () {
  echo  "=========================="
  echo "$(date): parameters updated"
  for p in ${params[@]};do
    eval "echo \$p = \$$p"
  done
  echo  "=========================="
}

# Read config function
read_config () {
  if [ ! -f "$CONFIG_FILE" ];then
    return
  fi
  is_updated=0
  while read name var;do
    if [ "$name" = "max" ] && [ "$max" != "$var" ] && [ "$var" != "" ] && expr $var + 1 >/dev/nul 2>&1;then
      is_updated=1
      max=$var
    elif [ "$name" = "prefix_1core" ] && [ "$prefix_1core" != "$var" ] && [ "$var" != "" ];then
      is_updated=1
      prefix_1core=$var
    elif [ "$name" = "image" ] && [ "$image" != "$var" ] && [ "$var" != "" ];then
      is_updated=1
       image=$var
    elif [ "$name" = "preemptible" ] && [ "$preemptible" != "$var" ];then
      is_updated=1
       preemptible=$var
    elif [ "$name" = "zones" ] && [ "${zones[*]}" != "$(echo $var|tr , ' ')" ];then
      is_updated=1
       zones=$(echo $var|tr , ' ')
    elif [ "$name" = "reuse" ] && [ "$reuse" != "$var" ];then
      is_updated=1
       reuse=$var
    fi
  done < "$CONFIG_FILE"
  if [ $is_updated -eq 1 ];then
    show_setup
  fi
}

read_config

# Check parameters
if [ "$max" -eq 0 ];then
  echo "set non-zero max"
  exit 1
fi

if [ -z "$prefix_1core" ];then
  echo "set prefix_1core"
  exit 2
fi

# Main loop
while :;do
  read_config

  # Set option
  option=""
  filter=""
  zone=""
  if [ -n "$image" ];then
    option="${option} --image $image"
  fi
  if [ "$preemptible" -eq 1 ];then
    option="${option} --preemptible"
  fi
  if [ -n "$zones" ];then
    filter="--filter=\"zone:($zones)\""
    option="${option} --zone=$(echo $zones|cut -d' ' -f1)"
    zone="--zone=$(echo $zones|cut -d' ' -f1)"
  fi

  # Check instances
  all=()
  terminated=()
  while read line;do
    instance=($line)
    state=${instance[((${#instance[@]}-1))]}
    if [ "$state" == "TERMINATED" ];then
      echo $reuse
      if [ $reuse -eq 1 ];then
        all=(${all[@]} ${instance[0]})
        terminated=(${terminated[@]} ${instance[0]})
      else
        echo "$ gcloud compute instances delete ${instance[0]} $zone"
        gcloud compute instances delete ${instance[0]} $zone
      fi
    else
      all=(${all[@]} ${instance[0]})
    fi
  done < <(eval gcloud compute instances list $filter|grep "^$prefix_1core")

  # Check condor status
  # 0: "Total", 1: Machines, 2: Owner, 3: Claimed, 4: Unclaimed, 5: Matched, 6: Preempting, 7: Drain
  total=($(condor_status -total |grep Total))
  if [ -z "${total[0]}" ] || ( [ ${total[1]} -lt $max ] && [ ${total[4]} -eq 0 ] );then
    n=1
    if [ ${#terminated[@]} -gt 0 ];then
      echo "$ gcloud compute start ${terminated[0]} $option"
      gcloud compute start ${terminated[0]} $option
    else
      while [ $n -lt 10000 ];do
        name=${prefix_1core}-$(printf "%04d" $n)
        if ! echo ${all[*]}|grep -q $name;then
          echo "$ gcloud compute instances create $name $option"
          gcloud compute instances create $name $option
          try=0
          while [ -z "$(condor_status |grep $name)" ];do
            ((try++))
            if [ $try -gt 100 ];then
              echo "condor in $name is still not running:"
              echo "Please check $name status"
              break
            fi
            sleep 1
          done
          break
        fi
        ((n++))
      done
    fi
  fi

  sleep 10
done
